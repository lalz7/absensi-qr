{% extends "base.html" %}

{% block title %}Kelola Siswa{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3 class="fw-bold mb-4 page-title"><i class="bi bi-person-fill me-2"></i>Kelola Data Siswa</h3>
    <div class="d-flex justify-content-end mb-3 gap-2">
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="bi bi-search me-2"></i>Cari & Filter
        </button>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#importModal">
            <i class="bi bi-file-earmark-arrow-up me-2"></i>Import dari CSV
        </button>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tambahSiswaModal">
            <i class="bi bi-plus-circle me-2"></i>Tambah Siswa
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Daftar Siswa</h5>
            {% if cari_nama or filter_kelas_id %}
                <a href="{{ url_for('siswa_bp.siswa') }}" class="btn btn-danger btn-sm">
                    <i class="bi bi-x-circle me-2"></i>Reset Filter
                </a>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr class="bg-light">
                            <th>No</th>
                            <th>NIS</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>No. HP Orang Tua</th>
                            <th>QR Code</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for siswa_data in siswa %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ siswa_data.nis }}</td>
                            <td>{{ siswa_data.nama }}</td>
                            <td>{{ siswa_data.kelas_relasi.nama if siswa_data.kelas_relasi else 'Tidak Diketahui' }}</td>
                            <td>{{ siswa_data.no_hp_ortu }}</td>
                            <td>
                                <img src="{{ url_for('siswa_bp.view_qr', nis=siswa_data.nis) }}" alt="QR Code" style="width: 50px; height: auto;">
                            </td>
                            <td class="text-nowrap">
                                <a href="{{ url_for('siswa_bp.siswa', edit_id=siswa_data.id) }}" class="btn btn-warning btn-sm me-1">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <a href="{{ url_for('siswa_bp.hapus_siswa', id=siswa_data.id) }}" class="btn btn-danger btn-sm me-1" onclick="return confirm('Apakah Anda yakin ingin menghapus data siswa ini?')"><i class="bi bi-trash"></i> Hapus</a>
                                <a href="{{ url_for('siswa_bp.download_qr', nis=siswa_data.nis) }}" class="btn btn-info btn-sm text-white"><i class="bi bi-download"></i> Download QR</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">Belum ada data siswa.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Impor Data Siswa dari CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Diberi ID supaya bisa dipaksa tampil oleh JS -->
                <div class="alert alert-info" role="alert" id="csv-note-container">
                    <h4 class="alert-heading">Catatan Penulisan File CSV</h4>
                    <p>File CSV harus memiliki kolom **nis, nama, no_hp, kelas** dengan urutan yang sama (tanpa spasi). Contoh:</p>
                    <pre>nis,nama,no_hp,kelas
001,Adrian Wibowo,0812345678,12 IPA - 1
002,Elkan Baggot,0812345679,12 IPA - 1</pre>
                    <hr>
                    <p class="mb-0">Pastikan nama kelas di file CSV **sama persis** dengan yang ada di sistem Anda.</p>
                </div>

                <!-- Pastikan form memiliki ID untuk direset oleh JS -->
                <form id="importCsvForm" action="{{ url_for('siswa_bp.import_siswa') }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">Pilih File CSV</label>
                        <input class="form-control" type="file" id="csvFile" name="csv_file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Import Data</button>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="tambahSiswaModal" tabindex="-1" aria-labelledby="tambahSiswaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="tambahSiswaForm" action="{{ url_for('siswa_bp.siswa') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="tambahSiswaModalLabel">Tambah Data Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nis" class="form-label">NIS</label>
                        <input type="text" class="form-control" id="nis-input" name="nis" required>
                    </div>
                    <div class="mb-3">
                        <label for="nama" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="nama-input" name="nama" required>
                    </div>
                    <div class="mb-3">
                        <label for="kelas" class="form-label">Kelas</label>
                        <select class="form-select" id="kelas-input" name="kelas" required>
                            <option value="" disabled selected>Pilih Kelas</option>
                            {% for k in semua_kelas %}
                            <option value="{{ k.id }}">{{ k.nama }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="no_hp" class="form-label">No. HP Orang Tua</label>
                        <input type="tel" class="form-control" id="no-hp-input" name="no_hp" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Tambahkan Siswa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editSiswaModal" tabindex="-1" aria-labelledby="editSiswaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Pastikan action diarahkan ke route siswa -->
            <form id="editSiswaForm" action="{{ url_for('siswa_bp.siswa') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSiswaModalLabel">Edit Data Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hidden input penting untuk mengirim edit_id -->
                    <input type="hidden" name="edit_id" value="{{ siswa_edit.id if siswa_edit else '' }}">

                    <div class="mb-3">
                        <label for="edit-nis" class="form-label">NIS</label>
                        <!-- readonly supaya tidak bisa diubah -->
                        <input type="text" class="form-control" id="edit-nis" name="nis"
                               value="{{ siswa_edit.nis if siswa_edit else '' }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="edit-nama" class="form-label">Nama</label>
                        <input type="text" class="form-control" id="edit-nama" name="nama"
                               value="{{ siswa_edit.nama if siswa_edit else '' }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-kelas" class="form-label">Kelas</label>
                        <select class="form-select" id="edit-kelas" name="kelas" required>
                            <option value="" disabled selected>Pilih Kelas</option>
                            {% for k in semua_kelas %}
                            <option value="{{ k.id }}" {% if siswa_edit and siswa_edit.kelas_id == k.id %}selected{% endif %}>{{ k.nama }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-no-hp" class="form-label">No. HP Orang Tua</label>
                        <input type="tel" class="form-control" id="edit-no-hp" name="no_hp"
                               value="{{ siswa_edit.no_hp_ortu if siswa_edit else '' }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('siswa_bp.siswa') }}" method="get">
                <div class="modal-header">
                    <h5 class="modal-title" id="filterModalLabel">Cari & Filter Siswa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cari_nama" class="form-label">Nama Siswa</label>
                        <input type="text" class="form-control" id="cari_nama" name="cari_nama" value="{{ cari_nama or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="filter_kelas" class="form-label">Filter Kelas</label>
                        <select class="form-select" id="filter_kelas" name="filter_kelas">
                            <option value="">-- Semua Kelas --</option>
                            {% for k in semua_kelas %}
                            <option value="{{ k.id }}" {% if filter_kelas_id and filter_kelas_id|string == k.id|string %}selected{% endif %}>{{ k.nama }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('siswa_bp.siswa') }}" class="btn btn-danger me-auto">Reset Filter</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-dark">Cari</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit_id');

        // 1. Logic untuk menampilkan Modal Edit jika ada edit_id di URL
        if (editId) {
            const editModalElement = document.querySelector('#editSiswaModal');
            if (editModalElement) {
                const modalInstance = new bootstrap.Modal(editModalElement);
                modalInstance.show();
                // Opsional: Hapus parameter edit_id dari URL setelah modal ditampilkan
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // 2. Perbaikan Logika Modal Impor CSV (Perbaikan Ganda untuk Catatan)
        const importModalElement = document.getElementById('importModal');
        const importCsvForm = document.getElementById('importCsvForm');
        // Mendapatkan kontainer catatan CSV
        const csvNoteContainer = document.getElementById('csv-note-container');

        if (importModalElement && importCsvForm && csvNoteContainer) {
            // Event listener saat modal import AKAN DITAMPILKAN (show.bs.modal)
            importModalElement.addEventListener('show.bs.modal', function () {
                // Hati-hati: Reset form dulu untuk mengosongkan input file.
                importCsvForm.reset();

                // Solusi AGRESIF: Pastikan kontainer catatan selalu terlihat
                // Kita akan paksa style display-nya menjadi 'block' dan visibility 'visible'.
                csvNoteContainer.style.display = 'block';
                csvNoteContainer.style.visibility = 'visible';
                // Jika Bootstrap atau library lain menambahkan kelas 'd-none', kita hapus
                csvNoteContainer.classList.remove('d-none');
            });
        }
    });
</script>


{% endblock %}
{% endblock %}
